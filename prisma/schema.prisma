generator client {
  provider = "prisma-client-js"
  output   = "../app/node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  addresses     Address[]
  orders        Order[]
  cart          Cart?

  @@map("users")
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label       String?  // "Home", "Work", etc.
  firstName   String
  lastName    String
  street      String
  city        String
  postalCode  String?
  country     String   @default("Kosovo")
  phone       String?
  isDefault   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      Order[]

  @@map("addresses")
}

// ============================================
// PRODUCTS
// ============================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  image       String?
  sortOrder   Int       @default(0)
  
  products    Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  slug        String   @unique
  description String?
  
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  price       Decimal  @db.Decimal(10, 2)
  compareAt   Decimal? @db.Decimal(10, 2)  // Original price for sales
  
  images      String[] // Array of image URLs
  colors      Json?    // Array of { name, hex, image? }
  specs       Json?    // Key-value specs
  
  featured    Boolean  @default(false)
  inStock     Boolean  @default(true)
  stockCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@map("products")
}

// ============================================
// CART
// ============================================

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  quantity  Int     @default(1)
  color     String? // Selected color name
  
  @@unique([cartId, productId, color])
  @@map("cart_items")
}

// ============================================
// ORDERS
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Order {
  id            String        @id @default(cuid())
  orderNumber   String        @unique
  
  userId        String?
  user          User?         @relation(fields: [userId], references: [id])
  
  // Guest checkout info (if no user)
  guestEmail    String?
  guestPhone    String?
  
  addressId     String?
  address       Address?      @relation(fields: [addressId], references: [id])
  
  // Snapshot of shipping address (in case address changes later)
  shippingAddress Json
  
  items         OrderItem[]
  
  subtotal      Decimal       @db.Decimal(10, 2)
  shipping      Decimal       @db.Decimal(10, 2) @default(0)
  tax           Decimal       @db.Decimal(10, 2) @default(0)
  total         Decimal       @db.Decimal(10, 2)
  
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?       // "card", "cash", "bank_transfer"
  
  notes         String?
  trackingNumber String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("orders")
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  
  // Snapshot of product at time of order
  productName String
  productSku  String
  productImage String?
  
  quantity    Int
  price       Decimal @db.Decimal(10, 2)  // Price at time of order
  color       String?
  
  @@map("order_items")
}

// ============================================
// ADMIN
// ============================================

model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  role         String   @default("admin") // "admin", "superadmin"
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admins")
}
